# 如何从断点恢复中断的运行 (傻瓜式教程)

`rdagent` 在长时间运行时，会自动保存每一步的进度。如果程序意外中断，你可以通过以下步骤从上一个成功保存的点继续运行，而无需从头开始。

### 第一步：激活环境

首先，请确保你已经进入了正确的环境。

```bash
# 激活你的conda环境
conda activate rdagent4qlib
# 进入项目根目录
cd ~/projects/RD-Agent
```

### 第二步：找到需要恢复的断点文件

你需要找到最近一次运行中，最后一个被保存下来的步骤文件。这可以通过两个命令完成。

1.  **找到最新的运行文件夹：**

    ```bash
    # 这个命令会打印出 log/ 目录下最新的文件夹名
    ls -t log/ | head -n 1
    ```
    记下这个文件夹名，我们称之为 `<你的运行文件夹>`。

2.  **找到该文件夹里最新的步骤文件：**

    ```bash
    # 将下面的 <你的运行文件夹> 替换为上一步找到的名字
    find log/<你的运行文件夹>/__session__/ -type f | sort -V | tail -n 1
    ```
    这个命令会打印出一个完整的路径，例如 `log/20240520-153000/__session__/1/0_propose`。这就是我们需要的**断点文件路径**。

### 第三步：执行恢复命令

现在，使用下面的命令模板，将 **断点文件路径** 填入，然后执行即可。

```bash
# 将 <断点文件路径> 替换为你在第二步中找到的完整路径
dotenv run -- python -m rdagent.app.qlib_rd_loop.factor <断点文件路径> --checkout=True
```

**命令解释:**
*   `dotenv run --`: 确保加载 `.env` 文件中的配置。
*   `python -m rdagent.app.qlib_rd_loop.factor`: 运行主程序。
*   `<断点文件路径>`: 告诉程序要加载哪个历史进度。
*   `--checkout=True`: **最关键的参数**，它指示程序从指定的断点恢复，而不是开始新的运行。

---
**示例:**
假设你在第二步中找到的路径是 `log/20240520-153000/__session__/1/0_propose`，那么你最终需要执行的命令就是：

```bash
dotenv run -- python -m rdagent.app.qlib_rd_loop.factor log/20240520-153000/__session__/1/0_propose --checkout=True
```

### 自动化脚本（可选）

如果你经常需要恢复运行，可以创建一个简单的脚本来自动化这个过程：

```bash
#!/bin/bash
# 保存为 recover.sh 并赋予执行权限

# 激活环境
conda activate rdagent4qlib
cd ~/projects/RD-Agent

# 找到最新的运行和步骤
LATEST_RUN_ID=$(ls -t log/ | head -n 1)
LATEST_STEP_PATH=$(find "log/$LATEST_RUN_ID/__session__/" -type f -name "*_*" | sort -V | tail -n 1)

echo "发现最近的运行ID是: $LATEST_RUN_ID"
echo "发现需要恢复的步骤文件是: $LATEST_STEP_PATH"

# 执行恢复命令
dotenv run -- python -m rdagent.app.qlib_rd_loop.factor "$LATEST_STEP_PATH" --checkout=True
```

使用方法：
```bash
chmod +x recover.sh
./recover.sh
``` 